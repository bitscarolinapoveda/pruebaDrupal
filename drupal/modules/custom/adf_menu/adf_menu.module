<?php

/**
 * @file
 * Contains adf_menu.module.
 */

use Drupal\file\Entity\File;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function adf_menu_form_menu_link_content_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  $form['details'] = [
    '#type' => 'details',
    '#title' => t('Agregar'),
    '#prefix' => '<div id="inner-container-wrapper">',
    '#suffix' => '</div>',
    '#open' => FALSE,
  ];

  $form['details']['image'] = [
    '#type' => 'managed_file',
    '#title' => t('imagen'),
    '#default_value' => isset($t->configuration['details']['image']) ? $t->configuration['details']['image'] : '',
    '#upload_location' => 'public://',
    '#upload_validators' => [
      'file_validate_extensions' => ['png'],
    ],
  ];
}

/**
 * Implement blockSubmit().
 */
function block_submit($form, FormStateInterface $form_state) {
  $this->configuration['details'] = $form_state->getValue('details');

foreach ($this->configuration['details'] as $key => $default_value) {

    $fid = $form_state->getValue('details')[$key]['image'][0]
      ->get('fid');
    \Drupal::logger('my_module')->error(print_r($this->setFileAsPermanent($fid), TRUE));

    if ($fid) {
      $this->setFileAsPermanent($fid);

    }
  }
}

/**
 * Implement setFileAsPermanent().
 */
function set_file_as_permanent($fid) {
  if (is_array($fid)) {
    $fid = array_shift($fid);
  }

  $file = File::load($fid);

  if (!is_object($file)) {
    return;
  }

  $file->setPermanent();

  $file->save();

  \Drupal::service('file.usage')->add($file, 'adf_menu', 'adf_menu', 1);
}
